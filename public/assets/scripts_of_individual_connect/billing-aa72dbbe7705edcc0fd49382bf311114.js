function renderCouponInfo(t){var e=toFloat($(".general-plan-price").text());$(".sub-info").hide(),$("#apply-coupon-button").attr("href",t.info.subscribe_href),$("#current-coupon-code").text(t.info.coupon.id),$("#coupon_partner_id").val(t.info.partner_id),t.info.coupon.description&&($(".coupon-description").text(t.info.coupon.description),$(".coupon-description-info").show()),t.info.coupon.percent_off?$(".coupon-discount").text("-$"+(e/100*t.info.coupon.percent_off).toFixed(2)):t.info.coupon.amount_off?$(".coupon-discount").text("-$"+(t.info.coupon.amount_off/100).toFixed(2)):$(".coupon-discount").text(""),$(".coupon-info").show(),$(".grand-total").text("$"+(t.info.grand_total/100).toFixed(2)),$(".grand-total-info").show(),$("#users_subscribe").length>0&&upgradeTotalPrice()}function renderBundleCouponInfo(t){var e=toFloat($(".general-bundle-price").text());$(".sub-info").hide(),$("#current-coupon-code").text(t.code),t.description&&($(".coupon-description").text(t.description),$(".coupon-description-info").show()),"percent"==t.coupon_type?$(".coupon-discount").text("$"+parseFloat(e/100*t.discount).toFixed(2)).addClass("stricken"):"cents"==t.coupon_type?$(".coupon-discount").text("-$"+(t.discount/100).toFixed(2)):$(".coupon-discount").text(""),$(".coupon-info").show(),upgradeBundleTotalPrice(t)}function upgradePlan(t,e,n){$(".plan-name").text(t),$("#user_plan_id").val(e),$(".general-plan-price").text("$"+(n/100).toFixed(2))}function setDefaultPlanData(t,e,n){$(".plan-name").text(t),$("#user_plan_id").val(e),$(".general-plan-price").text(n)}function changeBillingForm(){$(".card-form-title").removeClass("active-header"),$(".address-form-title").addClass("active-header")}function checkCardNumber(){var t=$("#card_number"),e=$(t).val(),n=$(t).parent(),i=Stripe.card.validateCardNumber(e);i?($(t).parent().find(".error-field-msg").remove(),$(t).removeClass("border-error"),$(t).addClass("border-success")):($(t).removeClass("border-success"),$(t).addClass("border-error"),$(n).find(".error-field-msg").remove(),$(n).append('<span class="error-field-msg">Your card number is incorrect.</span>'))}function checkCardCode(){var t=$("#card_code"),e=$(t).val(),n=$(t).parent(),i=Stripe.card.validateCVC(e);i?($(t).parent().find(".error-field-msg").remove(),$(t).removeClass("border-error"),$(t).addClass("border-success")):($(t).removeClass("border-success"),$(t).addClass("border-error"),$(n).find(".error-field-msg").remove(),$(n).append('<span class="error-field-msg">Your card\'s security code is invalid.</span>'))}function submitStripe(t){var e=$.Deferred();return Stripe.setPublishableKey($('meta[name="stripe-key"]').attr("content")),Stripe.card.createToken({number:$("#card_number").val(),cvc:$("#card_code").val(),exp_month:$("#card_month").val(),exp_year:$("#card_year").val()},function(n,i){if(i.error)t.push(i.error.message);else{var o=i.id;stripe_token=i.id,$("#subscription_stripe_card_token").val(o)}e.resolve(t)}),e}function initCardExpirationSelect(){$("#card_month").select2({placeholder:"Select Month *",width:"100%"}).on("select2-close",function(){setTimeout(function(){$(".select2-container-active").removeClass("select2-container-active"),$(":focus").blur()},1)}),$("#card_year").select2({placeholder:"Select Year *",width:"100%"}).on("select2-close",function(){setTimeout(function(){$(".select2-container-active").removeClass("select2-container-active"),$(":focus").blur()},1)}),$("#card_month + .custom.dropdown").remove(),$("#card_year + .custom.dropdown").remove()}function openBlock(t){var e=$("#"+t),n=$("#reveal-"+t);$(e).show(),$(n).hide()}function closeBlock(t){var e=$("#"+t),n=$("#reveal-"+t);$(e).hide(),n&&$(n).show()}function initAddress(){var t=$("#address_state");$("#address_country").select2({placeholder:"Select Country *",width:"100%"}).on("change",function(e){$.ajax({url:"/get_states_by_country",dataType:"script",data:{selected_country:e.val},success:function(e){var n=$.parseJSON(e),i=['<option value=""></option>'];$.each(n,function(t,e){i.push(['<option value="',e.id,'">',e.name,"</option>"].join(""))}),1===i.length&&'<option value=""></option>'===i[0]?$("#s2id_address_state").addClass("hidden"):(dropdown=$("#s2id_address_state"),$(dropdown).removeClass("hidden"),$(dropdown).find(".select2-chosen").text("Select State *"),$(t).html(i),$(t).prop("disabled",!1))},error:function(){}})}).on("select2-close",function(){setTimeout(function(){$(".select2-container-active").removeClass("select2-container-active"),$(":focus").blur()},1)}),$(t).select2({placeholder:"Select State  *",width:"100%"}).on("select2-close",function(){setTimeout(function(){$(".select2-container-active").removeClass("select2-container-active"),$(":focus").blur()},1)}),$("#address_country + .custom.dropdown").remove(),$("#address_state + .custom.dropdown").remove()}function realTimeValidation(){$("input").change(function(){var t=$(this).prop("id");"user_email"==t?checkEmail(this):"user_password"==t||"user_password_confirmation"==t?checkPass():"card_number"==t?checkCardNumber():"card_code"==t?checkCardCode():checkIsFieldPresent(this)}),$("#address_state").change(setAddressStateDropdownBorder)}function checkIsFieldPresent(t){""==$(t).val()?($(t).removeClass("border-success"),$(t).addClass("border-error")):($(t).removeClass("border-error"),$(t).addClass("border-success"))}function checkPass(){var t=$("#user_password"),e=$(t).val(),n=$(t).parent(),i=$("#user_password_confirmation"),o=$(i).val();""!=e&&e.length>7&&e==o?($(n).find(".error-field-msg").remove(),$(t).removeClass("border-error"),$(i).removeClass("border-error"),$(t).addClass("border-success"),$(i).addClass("border-success")):""!=e&&e.length<7&&e==o?($(t).removeClass("border-success"),$(i).removeClass("border-success"),$(t).addClass("border-error"),$(i).addClass("border-error"),0==$(n).find(".error-field-msg").length&&$(n).append('<span class="error-field-msg">Password must contain at least eight characters!</span>')):($(t).removeClass("border-success"),$(i).removeClass("border-success"),$(t).removeClass("border-error"),$(i).removeClass("border-error"),$(n).find(".error-field-msg").remove())}function checkEmail(t){var e=$(t).val(),n=$(t).parent(),i=/^([\+\w-]+(?:\.[\+\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;i.test(e)?$.ajax({url:"/is_email_exist",dataType:"json",data:{email:e},success:function(e){e.email?($(t).removeClass("border-success"),$(t).addClass("border-error"),$(n).find(".error-field-msg").remove(),$(n).append('<span class="error-field-msg">That email is taken!</span>')):($(t).parent().find(".error-field-msg").remove(),$(t).removeClass("border-error"),$(t).addClass("border-success"))},error:function(t){}}):($(t).removeClass("border-success"),$(t).addClass("border-error"),$(n).find(".error-field-msg").remove(),$(n).append('<span class="error-field-msg">E-mail is invalid!</span>'))}function setAddressStateDropdownBorder(){""==$("#address_state").val()?$("#s2id_address_state a").css("border-color","#A52A2A"):$("#s2id_address_state a").css("border-color","#aaa")}function validateAndSetTrialForm(t,e){var n=$("#user_password").val(),i=$("#user_email").val();checkAllInputs()||t.push("These fields are required"),checkMatchingPass()||t.push("Passwords do not match"),n&&n.length<8&&t.push("Password must contain at least eight characters!"),email_reg.test(i)||t.push("E-mail is invalid"),$(this).hasClass("mobile")?$.when(submitStripe(t),$.ajax({url:"/is_email_exist",dataType:"json",data:{email:i},success:function(e){e.email&&t.push("That email is taken!")},error:function(t){}})).then(function(){0==t.length?submitTrialForm():(showErrors(t,e),setAddressStateDropdownBorder(),$("input[type=text][id!=address_line2]").filter(function(){return""==this.value}).addClass("border-error"))}):0==t.length?addAddressAndSubscribe():(showErrors(t,e),setAddressStateDropdownBorder(),$("input[type=text][id!=address_line2]").filter(function(){return""==this.value}).addClass("border-error"))}function validateAndSetAccountForm(t,e){checkValidCardInputs()&&checkValidAddressInput()||t.push("These fields are required"),submitStripe(t),0==t.length?$("#billing-form").submit():(showErrors(t,e),setAddressStateDropdownBorder(),$("input[type=text][id!=address_line2]").filter(function(){return""==this.value}).addClass("border-error"))}function submitTrialForm(){$("#trial-signup").submit()}function saveAccountUser(){$.ajax({url:"/create_user_from_trial",dataType:"json",data:{user:{fname:$("#user_fname").val(),lname:$("#user_lname").val(),email:$("#user_email").val(),password:$("#user_password").val(),password_confirmation:$("#user_password_confirmation").val()}},success:function(t){user_id=t.user_id},error:function(t){}})}function addAddressAndSubscribe(){$.ajax({url:"/update_user_after_finish_trial_page",dataType:"script",data:{user_id:user_id,redirect_to:"/dashboard?complete_registration",subscription:{stripe_card_token:stripe_token,plan_id:gon.free_month_plan_id},address:{country:$("#address_country").val(),state:$("#address_state").val(),city:$("#address_city").val(),address_line1:$("#address_line1").val(),address_line2:$("#address_line2").val(),zip_code:$("#address_zip").val()}},success:function(){},error:function(){}})}function checkAllInputs(){return checkValidAccountInputs()&&checkValidCardInputs()&&checkValidAddressInput()}function checkMatchingPass(){return 0==$(".mismatching_pass").length}function addBindToSubscribeButton(){var t=$(".subscribe-to-plan");$(t).unbind("click"),$(t).click(function(){var t=$("#coupon-code").val(),e="/subscribe/"+$(this).data("plan"),n="block"==$(".coupon-status.valid").css("display");""!=t&&n&&(e=e+"/with-coupon/"+t),window.location.href=e})}function upgradeTotalPrice(){var t=toFloat($(".general-plan-price").text()),e=toFloat($(".coupon-discount").text()),n=toFloat($(".wop-payout").text()),i=null,o=null;window.location.pathname.indexOf("trial_month")>0&&(t=0),i=t-e,0>i&&(i=0),o=i+n,$(".total-payout-today").text("$"+parseFloat(o).toFixed(2))}function upgradeBundleTotalPrice(t){var e=toFloat($(".coupon-discount").text()),n=toFloat($(".general-bundle-price").text()),i=null,o=$(".coupon-discount");return $("#card_number").removeAttr("disabled"),$("#card_code").removeAttr("disabled"),$("#card_month").select2("enable"),$("#card_year").select2("enable"),t?($(o).removeClass("stricken"),void("free"==t.coupon_type?($(o).text("Free"),$("#card_number").attr("disabled","disabled"),$("#card_code").attr("disabled","disabled"),$("#card_month").select2("disable"),$("#card_year").select2("disable"),$(".total-payout-today").text("$00.00")):(i=n-e,0>i&&(i=0),$(".total-payout-today").text("$"+parseFloat(i).toFixed(2)),$(o).text("$"+parseFloat(e).toFixed(2)).addClass("stricken")))):void $(".total-payout-today").text($(".general-bundle-price").text())}function toFloat(t){var e=t.match(/[-+]?[0-9]*\.?[0-9]+/);return e&&e.length>0?parseFloat(e[0]):0}var user_id,stripe_token;$(document).ready(function(){var t=$(".js-errors-block"),e=/^([\+\w-]+(?:\.[\+\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i,n=$("#coupon-code");$(".plan-name").text(),$("#user_plan_id").val(),$(".general-plan-price").text();initAddress(),initCardExpirationSelect(),$("#address-form").hide(),$("#submit-account").click(function(){var n=[],i=$("#user_password").val(),o=$("#user_email").val();$(t).hide(),checkValidAccountInputs()||n.push("These fields are required"),0==n.length?(checkMatchingPass()||n.push("Passwords do not match"),i&&i.length<8&&n.push("Password must contain at least eight characters!"),e.test(o)||n.push("E-mail is invalid"),$.ajax({url:"/is_email_exist",dataType:"json",data:{email:o},success:function(e){e.email&&n.push("That email is taken!"),0==n.length?(closeBlock("account-form"),openBlock("card-form"),saveAccountUser(),ga&&ga("send","event","Registration","Email Registration","No Credit Card")):(showErrors(n,t),$("#account-form").find("input:text, input:password, input[type=email]").filter(function(){return""==this.value}).addClass("border-error"))},error:function(t){}})):(showErrors(n,t),$("#account-form").find("input:text, input:password, input[type=email]").filter(function(){return""==this.value}).addClass("border-error"))}),$("#submit-card").click(function(){var e,n=[],i=$("#user_plan_id").val(),o=null,s=$(".coupon-discount").text(),a=null,r=null;return $(t).hide(),checkValidCardInputs()||"Free"==s||(n.push("These fields are required"),$("#card-form").find("input[type=text][id!=bundle_code][id!=coupon-code]").filter(function(){return""==this.value}).addClass("border-error")),checkValidBundleCoupon()||n.push("Bundle coupon is invalid"),e=checkValidCoupon(),e&&0!=e.valid||n.push("Coupon is invalid"),e&&e.valid&&e.info.plan&&(r=e.info.plan.id,o=e.info.plan.label),a=e&&e.valid&&!r||e&&e.valid&&!i||e&&e.valid&&i&&r&&i==r,e&&e.valid&&!a&&n.push("This coupon valid only for "+o+" plan"),n.length>0?void showErrors(n,t):void("Free"!=s?(Stripe.setPublishableKey($('meta[name="stripe-key"]').attr("content")),Stripe.card.createToken({number:$("#card_number").val(),cvc:$("#card_code").val(),exp_month:$("#card_month").val(),exp_year:$("#card_year").val()},function(e,i){if(i.error)n.push(i.error.message);else{var o=i.id;stripe_token=i.id,$("#subscription_stripe_card_token").val(o),$("#user_stripe_card_token").val(o)}0==n.length?(closeBlock("card-form"),openBlock("address-form"),changeBillingForm()):(showErrors(n,t),$("#card-form").find("input[type=text][id!=bundle_code][id!=coupon-code]").filter(function(){return""==this.value}).addClass("border-error"))})):(closeBlock("card-form"),openBlock("address-form"),changeBillingForm()))}),$("#submit-address").click(function(e){e.preventDefault();var n=[];$(t).hide(),$(this).hasClass("trial-page")?validateAndSetTrialForm(n,t):$(this).hasClass("account-page")?validateAndSetAccountForm(n,t):(checkValidAddressInput()||(n.push("These fields are required"),$("#card-form").find("input[type=text][id!=address_line2]").filter(function(){return""==this.value}).addClass("border-error")),0==n.length?$("form").submit():(showErrors(n,t),setAddressStateDropdownBorder(),$("input[type=text][id!=address_line2]").filter(function(){return""==this.value}).addClass("border-error")))}),n.keyup(function(){$(".invalid").hide(),$(".valid").hide(),$(t).hide(),$(".coupon-info").hide(),$("#apply-coupon-button").show(),addBindToSubscribeButton(),""==$(this).val()&&($(".coupon-discount").text(""),upgradeTotalPrice("amount"))}),$("#bundle_code").keyup(function(){$(".invalid").hide(),$(".valid").hide(),$(".coupon-info").hide(),$("#apply-bundle-coupon-button").show(),$(".coupon-discount").text(""),""==$(this).val()&&upgradeBundleTotalPrice()}),$("#apply-coupon-button").click(function(e){e.preventDefault(),$(t).hide(),$(".checking-in-progress").show();var i=$(n).val(),o="amount",s=$("#user_plan_id").val(),a=[],r=null,l=null;if(""!=i){$(".coupon-info").hide();var c=checkValidCoupon(i),u=c===!0||c.valid,d=null;if(u&&c.info.plan&&(r=c.info.plan.id,l=c.info.plan.label),d=u&&!r||u&&!s||u&&s&&r&&s==r,u&&d)return $(".checking-in-progress").hide(),$(".invalid").hide(),$("#apply-coupon-button").hide(),$(".valid").show(),""==!c.info.partner_id&&"local"==c.info.coupon_type?$(".not_upgrade_mode").show():$(".not_upgrade_mode").hide(),addBindToSubscribeButton(),renderCouponInfo(c),void $(".coupon-info").show();u&&!d&&(a.push("This coupon valid only for "+l+" plan"),showErrors(a,t)),$(".checking-in-progress").hide(),$(".subscribe-to-plan").unbind("click"),$(".invalid").show(),$(".valid").hide(),$("#apply-coupon-button").hide(),$(".coupon-discount").text(""),upgradeTotalPrice(o)}else $(".checking-in-progress").hide(),$(".invalid").hide(),$(".valid").hide(),$("#apply-coupon-button").show(),$(".coupon-info").hide(),$(".coupon-discount").text(""),$("#coupon").val(i),addBindToSubscribeButton(),upgradeTotalPrice(o)}),$("#apply-bundle-coupon-button").click(function(t){t.preventDefault();var e=$(".coupon-info"),n=$(".checking-in-progress");$(e).hide(),$(n).show();var i=checkValidBundleCoupon();return""==$("#bundle_code").val()?($(n).hide(),$(".invalid").hide(),$(".valid").hide(),$(e).hide(),$(".coupon-discount").text(""),upgradeBundleTotalPrice(),!0):void(i?($(n).hide(),$(".invalid").hide(),$(this).hide(),$(".valid").show(),renderBundleCouponInfo(i),$(e).show()):($(n).hide(),$(".invalid").show(),$(".valid").hide(),$(this).hide(),$(e).hide(),$(".coupon-discount").text(""),upgradeBundleTotalPrice()))})});